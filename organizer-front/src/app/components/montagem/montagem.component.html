<div class="container-fluid py-4 montagem-container">
<h3 class="mb-3">Montagem</h3>

  <div
    *ngIf="msg.type"
    class="alert"
    [ngClass]="{
      'alert-success': msg.type === 'success',
      'alert-danger': msg.type === 'danger',
    }"
  >
    {{ msg.text }}
  </div>

  <form (ngSubmit)="confirmar()" [formGroup]="form" novalidate class="mb-4">
    <div class="row g-3">
      <div class="col-12">
        <label class="form-label" for="responsavel">Nome do responsável</label>
        <div class="name-field-wrap">
          <input
            id="responsavel"
            type="text"
            class="form-control form-control-lg"
            formControlName="nome"
            autocomplete="name"
            placeholder="Quem está na etapa agora"
          />
          <button
            type="button"
            class="btn btn-outline-secondary name-clear-btn"
            (click)="limpar()"
            [disabled]="loading"
          >
            Limpar
          </button>
        </div>
        <div class="form-text mt-2">
          Informe uma vez e use o botão desejado: Montar, Vincar ou ambos.
        </div>
      </div>
    </div>
  </form>

  <ng-template #complexidadeStarsTemplate let-score="score">
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <div class="complexidade-stars">
        <span
          *ngFor="let idx of dxfStarIndices"
          class="complexidade-star"
          [class.filled]="score >= idx + 1"
          [class.half]="score >= idx + 0.5 && score < idx + 1"
        >
          &#9733;
        </span>
      </div>
      <small class="text-muted">{{ score | number: '1.1-1' }}</small>
    </div>
  </ng-template>

  <!-- Desktop layout -->
  <div class="d-none d-lg-block">
    <div *ngIf="!tiradas || tiradas.length === 0" class="text-muted pb-3">
      Nenhuma faca em montagem no momento.
    </div>

    <div *ngIf="tiradas?.length" class="table-responsive">
      <table class="table table-sm table-hover align-middle table-montagem">
        <thead class="table-light">
          <tr>
            <th style="width: 80px">NR</th>
            <th>Cliente</th>
            <th>Status</th>
            <th style="min-width: 180px">Montagem</th>
            <th style="min-width: 180px">Vinco</th>
            <th style="min-width: 160px">Complexidade</th>
            <th>Atributos</th>
            <th>Obs</th>
            <th style="width: 120px">Criado</th>
            <th style="min-width: 220px">Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let p of tiradas; trackBy: trackById">
            <td class="fw-semibold fs-5">{{ p.nr }}</td>
            <td>
              <div class="fw-semibold">{{ p.cliente }}</div>
              <div class="small text-muted" *ngIf="p.observacao">
                {{ p.observacao }}
              </div>
            </td>
            <td>
              <span class="badge" [ngClass]="statusBadgeClass(p.status)">
                {{ getStatusLabel(p.status) }}
              </span>
            </td>
            <td>
              <div>
                <span *ngIf="p.montador; else pendenteMontagemDesktop">{{
                  p.montador
                }}</span>
              </div>
              <div class="small text-muted" *ngIf="p.dataMontagem">
                {{ p.dataMontagem | date: "dd/MM HH:mm" }}
              </div>
              <ng-template #pendenteMontagemDesktop>
                <span class="text-muted">Pendente</span>
              </ng-template>
            </td>
            <td>
              <div>
                <span *ngIf="p.vincador; else pendenteVincoDesktop">{{
                  p.vincador
                }}</span>
              </div>
              <div class="small text-muted" *ngIf="p.dataVinco">
                {{ p.dataVinco | date: "dd/MM HH:mm" }}
              </div>
              <ng-template #pendenteVincoDesktop>
                <span class="text-muted">Pendente</span>
              </ng-template>
            </td>
            <td class="complexidade-cell">
              <ng-container [ngSwitch]="complexidadeEstado(p.nr)">
                <div class="text-muted small" *ngSwitchCase="'loading'">
                  Carregando...
                </div>
                <ng-container *ngSwitchCase="'ready'">
                  <ng-container
                    *ngTemplateOutlet="
                      complexidadeStarsTemplate;
                      context: { score: complexidadeValor(p.nr) }
                    "
                  ></ng-container>
                </ng-container>
                <div class="text-muted small" *ngSwitchDefault>—</div>
              </ng-container>
            </td>
            <td>
              <div class="d-flex flex-wrap gap-1">
                <span class="badge bg-success" *ngIf="p.emborrachada"
                  >Emborrachada</span
                >
                <span class="badge bg-secondary" *ngIf="p.destacador"
                  >Dest: {{ p.destacador }}</span
                >
                <span class="badge bg-info text-dark" *ngIf="p.pertinax"
                  >Pertinax</span
                >
                <span class="badge bg-info text-dark" *ngIf="p.poliester"
                  >Poliéster</span
                >
                <span class="badge bg-info text-dark" *ngIf="p.papelCalibrado"
                  >Papel cal.</span
                >
              </div>
            </td>
            <td>{{ p.observacao || "—" }}</td>
            <td>{{ p.dataH | date: "dd/MM HH:mm" }}</td>
            <td>
              <div class="d-flex flex-wrap gap-2 justify-content-end">
                <button
                  class="btn btn-success btn-sm"
                  (click)="acaoRapida(p.nr, 'montar')"
                  [disabled]="!podeMontar(p)"
                >
                  Montar
                </button>
                <button
                  class="btn btn-warning btn-sm"
                  (click)="acaoRapida(p.nr, 'vincar')"
                  [disabled]="!podeVincar(p)"
                >
                  Vincar
                </button>
                <button
                  class="btn btn-info btn-sm text-white"
                  (click)="acaoRapida(p.nr, 'montarVincar')"
                  [disabled]="!podeMontarVincar(p)"
                >
                  Montar e Vincar
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Mobile layout -->
  <div class="card d-lg-none">
    <div
      class="card-header d-flex justify-content-between align-items-center gap-2"
    >
      <strong>Facas em montagem</strong>
      <small class="text-muted" *ngIf="tiradas?.length"
        >{{ tiradas.length }} item(ns)</small
      >
    </div>
    <div class="card-body">
      <div *ngIf="!tiradas || tiradas.length === 0" class="text-muted mb-0">
        Nenhuma faca em montagem no momento.
      </div>
      <div *ngIf="tiradas?.length" class="d-grid gap-3">
        <div
          class="border rounded p-3"
          *ngFor="let p of tiradas; trackBy: trackById"
        >
          <div class="d-flex justify-content-between align-items-start gap-2">
            <div>
              <div class="fw-bold">NR {{ p.nr }}</div>
              <div class="small text-muted">{{ p.cliente }}</div>
            </div>
            <span class="badge" [ngClass]="statusBadgeClass(p.status)">
              {{ getStatusLabel(p.status) }}
            </span>
          </div>

          <div class="mt-3 small">
            <div class="fw-semibold">Montagem</div>
            <div>
              <span *ngIf="p.montador; else pendenteMontagemMobile">{{
                p.montador
              }}</span>
              <ng-template #pendenteMontagemMobile>
                <span class="text-muted">Pendente</span>
              </ng-template>
            </div>
            <div class="text-muted" *ngIf="p.dataMontagem">
              {{ p.dataMontagem | date: "dd/MM HH:mm" }}
            </div>
          </div>

          <div class="mt-2 small">
            <div class="fw-semibold">Vinco</div>
            <div>
              <span *ngIf="p.vincador; else pendenteVincoMobile">{{
                p.vincador
              }}</span>
              <ng-template #pendenteVincoMobile>
                <span class="text-muted">Pendente</span>
              </ng-template>
            </div>
            <div class="text-muted" *ngIf="p.dataVinco">
              {{ p.dataVinco | date: "dd/MM HH:mm" }}
            </div>
          </div>

          <div class="mt-3 small">
            <div class="fw-semibold">Complexidade</div>
            <ng-container [ngSwitch]="complexidadeEstado(p.nr)">
              <div class="text-muted" *ngSwitchCase="'loading'">
                Carregando...
              </div>
              <ng-container *ngSwitchCase="'ready'">
                <ng-container
                  *ngTemplateOutlet="
                    complexidadeStarsTemplate;
                    context: { score: complexidadeValor(p.nr) }
                  "
                ></ng-container>
              </ng-container>
              <div class="text-muted" *ngSwitchDefault>—</div>
            </ng-container>
          </div>

          <div
            class="mt-3 d-flex flex-wrap gap-1"
            *ngIf="
              p.emborrachada ||
              p.destacador ||
              p.pertinax ||
              p.poliester ||
              p.papelCalibrado
            "
          >
            <span class="badge bg-success" *ngIf="p.emborrachada"
              >Emborrachada</span
            >
            <span class="badge bg-secondary" *ngIf="p.destacador"
              >Dest: {{ p.destacador }}</span
            >
            <span class="badge bg-info text-dark" *ngIf="p.pertinax"
              >Pertinax</span
            >
            <span class="badge bg-info text-dark" *ngIf="p.poliester"
              >Poliéster</span
            >
            <span class="badge bg-info text-dark" *ngIf="p.papelCalibrado"
              >Papel cal.</span
            >
          </div>
          <div
            class="mt-3 small text-muted"
            *ngIf="
              !(
                p.emborrachada ||
                p.destacador ||
                p.pertinax ||
                p.poliester ||
                p.papelCalibrado
              )
            "
          >
            Sem atributos adicionais.
          </div>

          <div class="mt-3 small" *ngIf="p.observacao">
            <span class="fw-semibold">Obs:</span> {{ p.observacao }}
          </div>

          <div class="mt-3 small text-muted">
            Criado: {{ p.dataH | date: "dd/MM HH:mm" }}
          </div>

          <div class="mt-3 d-grid gap-2">
            <button
              class="btn btn-success btn-sm"
              (click)="acaoRapida(p.nr, 'montar')"
              [disabled]="!podeMontar(p)"
            >
              Montar
            </button>
            <button
              class="btn btn-warning btn-sm"
              (click)="acaoRapida(p.nr, 'vincar')"
              [disabled]="!podeVincar(p)"
            >
              Vincar
            </button>
            <button
              class="btn btn-info btn-sm text-white"
              (click)="acaoRapida(p.nr, 'montarVincar')"
              [disabled]="!podeMontarVincar(p)"
            >
              Montar e Vincar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Feedback do último pedido atualizado -->
  <div *ngIf="pedidoEncontrado" class="mt-3 small text-muted">
    <div>
      <strong>Último:</strong> NR {{ pedidoEncontrado.nr }} →
      <strong>{{ getStatusLabel(pedidoEncontrado.status) }}</strong>
    </div>
    <div *ngIf="pedidoEncontrado.montador">
      Montador: {{ pedidoEncontrado.montador }} (
      {{ pedidoEncontrado.dataMontagem | date: "dd/MM HH:mm" }})
    </div>
    <div *ngIf="pedidoEncontrado.vincador">
      Vincador: {{ pedidoEncontrado.vincador }} (
      {{ pedidoEncontrado.dataVinco | date: "dd/MM HH:mm" }})
    </div>
  </div>
</div>
