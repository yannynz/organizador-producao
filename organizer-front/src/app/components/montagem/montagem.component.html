<div class="container-fluid py-4 montagem-container">
<div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
  <h3 class="mb-0">Montagem</h3>
  <div class="flex-grow-1" style="max-width: 400px; min-width: 250px;">
     <div class="input-group">
        <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
        <input type="text" class="form-control border-start-0 ps-0" placeholder="Buscar por NR ou Cliente..." [(ngModel)]="searchTerm" (input)="filterOrders()">
        <button class="btn btn-outline-secondary" type="button" *ngIf="searchTerm" (click)="searchTerm=''; filterOrders()"><i class="bi bi-x"></i></button>
     </div>
  </div>
</div>

  <div
    *ngIf="msg.type"
    class="alert"
    [ngClass]="{
      'alert-success': msg.type === 'success',
      'alert-danger': msg.type === 'danger',
    }"
  >
    {{ msg.text }}
  </div>

  <form (ngSubmit)="confirmar()" [formGroup]="form" novalidate class="mb-4">
    <div class="row g-3">
      <div class="col-12">
        <label class="form-label" for="responsavel">Nome do responsável</label>
        <app-user-selector 
            formControlName="nome" 
            [availableUsers]="users" 
            placeholder="Quem está na etapa agora">
        </app-user-selector>
        <div class="form-text mt-2">
          Informe uma vez e use o botão desejado: Montar, Vincar ou ambos.
        </div>
      </div>
    </div>
  </form>

  <ng-template #complexidadeStarsTemplate let-score="score">
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <div class="complexidade-stars">
        <span
          *ngFor="let idx of dxfStarIndices"
          class="complexidade-star"
          [class.filled]="score >= idx + 1"
          [class.half]="score >= idx + 0.5 && score < idx + 1"
        >
          &#9733;
        </span>
      </div>
      <small class="text-muted">{{ score | number: '1.1-1' }}</small>
    </div>
  </ng-template>

  <!-- Desktop layout -->
  <div class="d-none d-lg-block">
    <div *ngIf="!filteredTiradas || filteredTiradas.length === 0" class="text-muted pb-3">
      Nenhuma faca encontrada.
    </div>

    <div *ngIf="filteredTiradas?.length" class="table-responsive">
      <table class="table table-sm table-hover align-middle table-montagem">
        <thead class="table-light">
          <tr>
            <th style="width: 80px">NR</th>
            <th>Cliente</th>
            <th>Status</th>
            <th style="min-width: 180px">Montagem</th>
            <th style="min-width: 180px">Vinco</th>
            <th style="min-width: 160px">Complexidade</th>
            <th>Atributos</th>
            <th>Obs</th>
            <th style="width: 120px">Criado</th>
            <th style="min-width: 260px">Ações</th> <!-- Largura aumentada para caber o botão -->
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let p of filteredTiradas; trackBy: trackById">
            <tr>
              <td class="fw-semibold fs-5">{{ p.nr }}</td>
              <td>
                <div class="fw-semibold">{{ p.cliente }}</div>
                <div class="small text-muted" *ngIf="p.observacao">
                  {{ p.observacao }}
                </div>
              </td>
              <td>
                <span class="badge" [ngClass]="statusBadgeClass(p.status)">
                  {{ getStatusLabel(p.status) }}
                </span>
              </td>
              <td>
                <div>
                  <span *ngIf="p.montador; else pendenteMontagemDesktop">{{
                    p.montador
                  }}</span>
                </div>
                <div class="small text-muted" *ngIf="p.dataMontagem">
                  {{ p.dataMontagem | date: "dd/MM HH:mm" }}
                </div>
                <ng-template #pendenteMontagemDesktop>
                  <span class="text-muted">Pendente</span>
                </ng-template>
              </td>
              <td>
                <div>
                  <span *ngIf="p.vincador; else pendenteVincoDesktop">{{
                    p.vincador
                  }}</span>
                </div>
                <div class="small text-muted" *ngIf="p.dataVinco">
                  {{ p.dataVinco | date: "dd/MM HH:mm" }}
                </div>
                <ng-template #pendenteVincoDesktop>
                  <span class="text-muted">Pendente</span>
                </ng-template>
              </td>
              <td class="complexidade-cell">
                <ng-container [ngSwitch]="complexidadeEstado(p.nr)">
                  <div class="text-muted small" *ngSwitchCase="'loading'">
                    Carregando...
                  </div>
                  <ng-container *ngSwitchCase="'ready'">
                    <ng-container
                      *ngTemplateOutlet="
                        complexidadeStarsTemplate;
                        context: { score: complexidadeValor(p.nr) }
                      "
                    ></ng-container>
                  </ng-container>
                  <div class="text-muted small" *ngSwitchDefault>—</div>
                </ng-container>
              </td>
              <td>
                <div class="d-flex flex-wrap gap-1">
                  <span class="badge bg-success" *ngIf="p.emborrachada"
                    >Emborrachada</span
                  >
                  <span class="badge bg-secondary" *ngIf="p.destacador"
                    >Dest: {{ p.destacador }}</span
                  >
                  <span class="badge bg-info text-dark" *ngIf="p.pertinax"
                    >Pertinax</span
                  >
                  <span class="badge bg-info text-dark" *ngIf="p.poliester"
                    >Poliéster</span
                  >
                  <span class="badge bg-info text-dark" *ngIf="p.papelCalibrado"
                    >Papel cal.</span
                  >
                </div>
              </td>
              <td>{{ p.observacao || "—" }}</td>
              <td>{{ p.dataH | date: "dd/MM HH:mm" }}</td>
              <td>
                <div class="d-flex flex-wrap gap-2 justify-content-end align-items-center">
                  <button class="btn btn-sm btn-outline-info" (click)="verMateriais(p.nr)" title="Ver Materiais">
                    <i class="bi bi-list-ul"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-secondary" (click)="toggleImage(p.nr)" title="Ver Imagem">
                    <i class="bi" [ngClass]="expandedNr === p.nr ? 'bi-chevron-up' : 'bi-image'"></i>
                  </button>
                  <button
                    class="btn btn-success btn-sm"
                    (click)="acaoRapida(p.nr, 'montar')"
                    [disabled]="!podeMontar(p)"
                  >
                    Montar
                  </button>
                  <button
                    class="btn btn-warning btn-sm"
                    (click)="acaoRapida(p.nr, 'vincar')"
                    [disabled]="!podeVincar(p)"
                  >
                    Vincar
                  </button>
                  <button
                    class="btn btn-info btn-sm text-white"
                    (click)="acaoRapida(p.nr, 'montarVincar')"
                    [disabled]="!podeMontarVincar(p)"
                  >
                    Ambos
                  </button>
                </div>
              </td>
            </tr>
            <!-- Linha Expandida Desktop -->
            <tr *ngIf="expandedNr === p.nr" class="bg-light">
              <td colspan="10" class="p-3">
                <div class="d-flex justify-content-center position-relative" style="min-height: 200px;">
                   <div *ngIf="loadingImage[p.nr]" class="position-absolute top-50 start-50 translate-middle">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                      </div>
                   </div>
                   <img *ngIf="imageUrls[p.nr]" [src]="imageUrls[p.nr]" class="img-fluid border rounded shadow-sm" style="max-height: 500px; object-fit: contain;" alt="Renderização da Faca">
                   <div *ngIf="!loadingImage[p.nr] && !imageUrls[p.nr]" class="text-muted py-5">
                      <i class="bi bi-image-alt fs-1 d-block text-center"></i>
                      <span>Imagem não disponível</span>
                   </div>
                </div>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Mobile layout -->
  <div class="card d-lg-none">
    <div
      class="card-header d-flex justify-content-between align-items-center gap-2"
    >
      <strong>Facas em montagem</strong>
      <small class="text-muted" *ngIf="filteredTiradas?.length"
        >{{ filteredTiradas.length }} item(ns)</small
      >
    </div>
    <div class="card-body">
      <div *ngIf="!filteredTiradas || filteredTiradas.length === 0" class="text-muted mb-0">
        Nenhuma faca encontrada.
      </div>
      <div *ngIf="filteredTiradas?.length" class="d-grid gap-3">
        <div
          class="border rounded p-3"
          *ngFor="let p of filteredTiradas; trackBy: trackById"
        >
          <div class="d-flex justify-content-between align-items-start gap-2">
            <div>
              <div class="fw-bold">NR {{ p.nr }}</div>
              <div class="small text-muted">{{ p.cliente }}</div>
            </div>
            <span class="badge" [ngClass]="statusBadgeClass(p.status)">
              {{ getStatusLabel(p.status) }}
            </span>
          </div>

          <!-- Botão Ver Materiais Mobile -->
          <div class="mt-2 d-grid">
             <button class="btn btn-outline-info btn-sm" (click)="verMateriais(p.nr)">
                <i class="bi bi-list-ul"></i> Ver Materiais
             </button>
          </div>

          <!-- Botão Ver Imagem Mobile - Mais visível -->
          <div class="mt-2 d-grid">
             <button class="btn btn-outline-primary btn-sm" (click)="toggleImage(p.nr)">
                <i class="bi" [ngClass]="expandedNr === p.nr ? 'bi-chevron-up' : 'bi-image'"></i>
                {{ expandedNr === p.nr ? 'Ocultar Imagem' : 'Ver Imagem da Faca' }}
             </button>
          </div>

          <!-- Área Expandida Mobile -->
          <div *ngIf="expandedNr === p.nr" class="mt-2 border rounded p-2 text-center bg-light">
             <div *ngIf="loadingImage[p.nr]" class="py-4">
                <div class="spinner-border text-primary" role="status"></div>
             </div>
             <img *ngIf="imageUrls[p.nr]" [src]="imageUrls[p.nr]" class="img-fluid rounded" style="max-height: 300px;" alt="Render">
             <div *ngIf="!loadingImage[p.nr] && !imageUrls[p.nr]" class="text-muted py-3">
                <small>Imagem indisponível</small>
             </div>
          </div>

          <div class="mt-3 small">
            <div class="fw-semibold">Montagem</div>
            <div>
              <span *ngIf="p.montador; else pendenteMontagemMobile">{{
                p.montador
              }}</span>
              <ng-template #pendenteMontagemMobile>
                <span class="text-muted">Pendente</span>
              </ng-template>
            </div>
            <div class="text-muted" *ngIf="p.dataMontagem">
              {{ p.dataMontagem | date: "dd/MM HH:mm" }}
            </div>
          </div>

          <div class="mt-2 small">
            <div class="fw-semibold">Vinco</div>
            <div>
              <span *ngIf="p.vincador; else pendenteVincoMobile">{{
                p.vincador
              }}</span>
              <ng-template #pendenteVincoMobile>
                <span class="text-muted">Pendente</span>
              </ng-template>
            </div>
            <div class="text-muted" *ngIf="p.dataVinco">
              {{ p.dataVinco | date: "dd/MM HH:mm" }}
            </div>
          </div>

          <div class="mt-3 small">
            <div class="fw-semibold">Complexidade</div>
            <ng-container [ngSwitch]="complexidadeEstado(p.nr)">
              <div class="text-muted" *ngSwitchCase="'loading'">
                Carregando...
              </div>
              <ng-container *ngSwitchCase="'ready'">
                <ng-container
                  *ngTemplateOutlet="
                    complexidadeStarsTemplate;
                    context: { score: complexidadeValor(p.nr) }
                  "
                ></ng-container>
              </ng-container>
              <div class="text-muted" *ngSwitchDefault>—</div>
            </ng-container>
          </div>

          <div
            class="mt-3 d-flex flex-wrap gap-1"
            *ngIf="
              p.emborrachada ||
              p.destacador ||
              p.pertinax ||
              p.poliester ||
              p.papelCalibrado
            "
          >
            <span class="badge bg-success" *ngIf="p.emborrachada"
              >Emborrachada</span
            >
            <span class="badge bg-secondary" *ngIf="p.destacador"
              >Dest: {{ p.destacador }}</span
            >
            <span class="badge bg-info text-dark" *ngIf="p.pertinax"
              >Pertinax</span
            >
            <span class="badge bg-info text-dark" *ngIf="p.poliester"
              >Poliéster</span
            >
            <span class="badge bg-info text-dark" *ngIf="p.papelCalibrado"
              >Papel cal.</span
            >
          </div>
          <div
            class="mt-3 small text-muted"
            *ngIf="
              !(
                p.emborrachada ||
                p.destacador ||
                p.pertinax ||
                p.poliester ||
                p.papelCalibrado
              )
            "
          >
            Sem atributos adicionais.
          </div>

          <div class="mt-3 small" *ngIf="p.observacao">
            <span class="fw-semibold">Obs:</span> {{ p.observacao }}
          </div>

          <div class="mt-3 small text-muted">
            Criado: {{ p.dataH | date: "dd/MM HH:mm" }}
          </div>

          <div class="mt-3 d-grid gap-2">
            <button
              class="btn btn-success btn-sm"
              (click)="acaoRapida(p.nr, 'montar')"
              [disabled]="!podeMontar(p)"
            >
              Montar
            </button>
            <button
              class="btn btn-warning btn-sm"
              (click)="acaoRapida(p.nr, 'vincar')"
              [disabled]="!podeVincar(p)"
            >
              Vincar
            </button>
            <button
              class="btn btn-info btn-sm text-white"
              (click)="acaoRapida(p.nr, 'montarVincar')"
              [disabled]="!podeMontarVincar(p)"
            >
              Montar e Vincar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Feedback do último pedido atualizado -->
  <div *ngIf="pedidoEncontrado" class="mt-3 small text-muted">
    <div>
      <strong>Último:</strong> NR {{ pedidoEncontrado.nr }} →
      <strong>{{ getStatusLabel(pedidoEncontrado.status) }}</strong>
    </div>
    <div *ngIf="pedidoEncontrado.montador">
      Montador: {{ pedidoEncontrado.montador }} (
      {{ pedidoEncontrado.dataMontagem | date: "dd/MM HH:mm" }})
    </div>
    <div *ngIf="pedidoEncontrado.vincador">
      Vincador: {{ pedidoEncontrado.vincador }} (
      {{ pedidoEncontrado.dataVinco | date: "dd/MM HH:mm" }})
    </div>
  </div>
</div>

<!-- Modal Materiais -->
<div class="modal fade show" tabindex="-1" style="display: block; background: rgba(0,0,0,0.5);" *ngIf="showMateriaisModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Materiais e Medidas - NR {{ selectedNr }}</h5>
        <button type="button" class="btn-close" (click)="fecharModalMateriais()"></button>
      </div>
      <div class="modal-body">
        <div *ngIf="loadingMateriais" class="text-center py-4">
            <div class="spinner-border text-primary" role="status"></div>
        </div>
        
        <div *ngIf="!loadingMateriais">
            <h6>Materiais da OP</h6>
            <ul *ngIf="materiaisOp && materiaisOp.length > 0; else semMateriais" class="list-group mb-3">
                <li *ngFor="let m of materiaisOp" class="list-group-item">{{ m }}</li>
            </ul>
            <ng-template #semMateriais>
                <p class="text-muted">Nenhum material listado na OP.</p>
            </ng-template>

            <h6>Medidas do DXF</h6>
            <div *ngIf="dxfMetrics; else semDxf" class="table-responsive">
                <table class="table table-bordered table-sm">
                    <thead>
                        <tr>
                            <th>Métrica</th>
                            <th>Valor</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let item of dxfMetrics | keyvalue">
                            <td>{{ item.key }}</td>
                            <td>{{ item.value }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <ng-template #semDxf>
                <p class="text-muted">Nenhuma medida encontrada no DXF.</p>
            </ng-template>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="fecharModalMateriais()">Fechar</button>
      </div>
    </div>
  </div>
</div>