<div class="card">
  <div class="card-body">
    <div class="d-flex justify-content-between mb-3">
      <div class="d-flex gap-2 w-50">
        <input type="text" class="form-control" placeholder="Buscar cliente..." [(ngModel)]="searchQuery" (keyup.enter)="search()">
        <button class="btn btn-primary" (click)="search()">Buscar</button>
      </div>
      <button class="btn btn-success" (click)="openNew()">
        <i class="bi bi-plus-lg"></i> Novo Cliente
      </button>
    </div>
    
    <table class="table table-striped table-hover align-middle text-sm">
      <thead>
        <tr>
          <th style="width: 20%">Cliente</th>
          <th style="width: 20%">Endereço Principal</th>
          <th style="width: 15%">Contatos</th>
          <th style="width: 15%">Docs / Info</th>
          <th style="width: 15%">Logística</th>
          <th style="width: 15%">Ações</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let c of clientes">
          <td>
            <div class="fw-bold text-truncate" title="{{c.nomeOficial}}">{{c.nomeOficial}}</div>
            <div class="small text-muted" *ngIf="c.apelidos">{{c.apelidos}}</div>
            <span class="badge rounded-pill" [class.bg-info]="c.origin==='OP'" [class.bg-secondary]="c.origin!=='OP'">{{c.origin}}</span>
            <span class="badge bg-danger ms-1" *ngIf="!c.ativo">Inativo</span>
          </td>
          
          <!-- Endereço: Limpo, apenas o default -->
          <td>
            <ng-container *ngIf="c.enderecos && c.enderecos.length > 0; else noAddr">
              <!-- Apenas o primeiro endereço (assumindo que o backend ordena ou traz o default primeiro, ou filtramos visualmente o default) -->
              <div *ngFor="let e of c.enderecos">
                <div *ngIf="e.isDefault">
                  <div class="text-truncate" title="{{e.logradouro}}">{{e.logradouro}}</div>
                  <small class="text-muted d-block">{{e.bairro}} - {{e.cidade}}/{{e.uf}}</small>
                  <small class="text-muted" *ngIf="e.cep">CEP: {{e.cep}}</small>
                </div>
              </div>
            </ng-container>
            <ng-template #noAddr><span class="text-muted text-small">-</span></ng-template>
          </td>

          <!-- Contatos: Email e Telefone -->
          <td>
            <div *ngIf="c.emailContato">
              <i class="bi bi-envelope me-1"></i><a [href]="'mailto:' + c.emailContato" class="text-decoration-none">{{c.emailContato}}</a>
            </div>
            <div *ngIf="c.telefone">
              <i class="bi bi-telephone me-1"></i>{{c.telefone}}
            </div>
            <span *ngIf="!c.emailContato && !c.telefone" class="text-muted">-</span>
          </td>

          <!-- Docs: CNPJ/IE -->
          <td>
            <div *ngIf="c.cnpjCpf" class="text-nowrap"><small class="fw-bold">Doc:</small> {{c.cnpjCpf}}</div>
            <div *ngIf="c.inscricaoEstadual" class="text-nowrap"><small class="fw-bold">IE:</small> {{c.inscricaoEstadual}}</div>
            <div *ngIf="c.ultimoServicoEm" class="mt-1 small text-muted" title="Último Serviço">
              <i class="bi bi-calendar-check"></i> {{c.ultimoServicoEm | date:'dd/MM/yy'}}
            </div>
          </td>

          <!-- Logística: Transp, Padrão e Horário -->
          <td>
             <div *ngIf="c.transportadoraName" class="fw-bold text-primary"><i class="bi bi-truck me-1"></i>{{c.transportadoraName}}</div>
             <div *ngIf="c.padraoEntrega" class="badge bg-light text-dark border">{{c.padraoEntrega}}</div>
             <div *ngIf="c.horarioFuncionamento" class="small text-muted mt-1"><i class="bi bi-clock me-1"></i>{{c.horarioFuncionamento}}</div>
          </td>

          <td>
            <button class="btn btn-sm btn-outline-primary" (click)="openEdit(c)">
              <i class="bi bi-pencil"></i> Editar
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<app-cliente-form *ngIf="showForm" [cliente]="selectedCliente!" (save)="onSave($event)" (cancel)="onCancel()"></app-cliente-form>