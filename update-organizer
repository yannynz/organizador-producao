#!/usr/bin/env bash
set -Eeuo pipefail

# Load installer-managed environment when available.
ORGANIZER_ENV_FILE="${ORGANIZER_ENV_FILE:-/etc/organizer/organizer.env}"
if [[ -r "$ORGANIZER_ENV_FILE" ]]; then
  # shellcheck disable=SC1090
  source "$ORGANIZER_ENV_FILE"
fi

# ===== Config =====
# Caminho do repositório (ajuste se necessário).
if [[ -z "${REPO_DIR:-}" ]]; then
  if [[ -n "${ORGANIZER_DIR:-}" ]]; then
    REPO_DIR="$ORGANIZER_DIR"
  elif [[ -d "$HOME/organizador-producao" ]]; then
    REPO_DIR="$HOME/organizador-producao"
  elif [[ -d "$HOME/Documents/organizador-producao" ]]; then
    REPO_DIR="$HOME/Documents/organizador-producao"
  else
    REPO_DIR="$HOME/organizador-producao"
  fi
fi
FRONT_DIR="organizer-front"
COMPOSE_FILE="docker-compose.yml"
USER_HOME="${USER_HOME:-$HOME}"
BASE_DIR="${BASE_DIR:-${DOCUMENTS_DIR:-$USER_HOME}}"
BACKUP_DIR="${BACKUP_DIR:-$BASE_DIR/backup_database}"

log() { printf "[%(%F %T)T] %s\n" -1 "$*"; }

# ===== Pré-checagens =====
command -v git >/dev/null || { echo "git não encontrado"; exit 1; }
command -v docker >/dev/null || { echo "docker não encontrado"; exit 1; }

if docker compose version >/dev/null 2>&1; then
  COMPOSE="docker compose"
elif command -v docker-compose >/dev/null 2>&1; then
  COMPOSE="docker-compose"
else
  echo "docker compose/docker-compose não encontrado"; exit 1
fi

# ===== Execução =====
log "Indo para o repositório: $REPO_DIR"
cd "$REPO_DIR"

log "Atualizando referências remotas (git fetch --all --prune)"
git fetch --all --prune

if [[ -n "$(git status --porcelain)" ]]; then
  log "Mudanças locais detectadas — executando git stash"
  git stash push -u -m "auto-stash $(date '+%F %T')" || true
else
  log "Sem mudanças locais para stash"
fi

log "Aplicando atualizações (git pull --rebase)"
git pull --rebase

log "Atualizando scripts operacionais em '$BACKUP_DIR'"
mkdir -p "$BACKUP_DIR"
cp "$REPO_DIR/scripts/ops/backup_postgres.sh" "$BACKUP_DIR/backup_postgres.sh"
cp "$REPO_DIR/scripts/ops/restore_backup.sh" "$BACKUP_DIR/restore_backup.sh"
chmod 750 "$BACKUP_DIR/backup_postgres.sh" "$BACKUP_DIR/restore_backup.sh"
if [[ -f "$REPO_DIR/scripts/ops/README.md" ]]; then
  cp "$REPO_DIR/scripts/ops/README.md" "$BACKUP_DIR/BACKUP_GUIDE.md"
  chmod 640 "$BACKUP_DIR/BACKUP_GUIDE.md"
fi

if command -v npm >/dev/null 2>&1; then
  log "Build do front Angular (produção) no host"
  cd "$FRONT_DIR"
  # Usa o ng local quando existir; senão, usa npx
  export NODE_OPTIONS="${NODE_OPTIONS:---max-old-space-size=4096}"
  npm ci --legacy-peer-deps
  npx ng build --configuration=production --ssr=false --prerender=false
  cd "$REPO_DIR"
else
  log "npm nao encontrado no host; build do front sera feito no Docker (docker compose build)."
fi

if $COMPOSE -f "$COMPOSE_FILE" build --help 2>/dev/null | grep -q -- "--no-parallel"; then
  log "Buildando imagens Docker com --no-parallel (mitiga falha intermitente do esbuild)"
  $COMPOSE -f "$COMPOSE_FILE" build --no-parallel backend-container frontend-container
else
  log "Buildando imagens Docker em modo sequencial (compatibilidade com Compose sem --no-parallel)"
  $COMPOSE -f "$COMPOSE_FILE" build backend-container
  $COMPOSE -f "$COMPOSE_FILE" build frontend-container
fi

log "Subindo containers (em segundo plano)"
$COMPOSE -f "$COMPOSE_FILE" up -d

log "Concluído com sucesso ✅"
