#!/usr/bin/env bash
set -Eeuo pipefail

# Load installer-managed environment when available.
ORGANIZER_ENV_FILE="${ORGANIZER_ENV_FILE:-/etc/organizer/organizer.env}"
if [[ -r "$ORGANIZER_ENV_FILE" ]]; then
  # shellcheck disable=SC1090
  source "$ORGANIZER_ENV_FILE"
fi

# ===== Config =====
# Caminho do repositório (ajuste se necessário).
if [[ -z "${REPO_DIR:-}" ]]; then
  if [[ -n "${ORGANIZER_DIR:-}" ]]; then
    REPO_DIR="$ORGANIZER_DIR"
  elif [[ -d "$HOME/organizador-producao" ]]; then
    REPO_DIR="$HOME/organizador-producao"
  elif [[ -d "$HOME/Documents/organizador-producao" ]]; then
    REPO_DIR="$HOME/Documents/organizador-producao"
  else
    REPO_DIR="$HOME/organizador-producao"
  fi
fi
FRONT_DIR="organizer-front"
COMPOSE_FILE="docker-compose.yml"

log() { printf "[%(%F %T)T] %s\n" -1 "$*"; }

# ===== Pré-checagens =====
command -v git >/dev/null || { echo "git não encontrado"; exit 1; }
command -v docker >/dev/null || { echo "docker não encontrado"; exit 1; }

if docker compose version >/dev/null 2>&1; then
  COMPOSE="docker compose"
elif command -v docker-compose >/dev/null 2>&1; then
  COMPOSE="docker-compose"
else
  echo "docker compose/docker-compose não encontrado"; exit 1
fi

# ===== Execução =====
log "Indo para o repositório: $REPO_DIR"
cd "$REPO_DIR"

log "Atualizando referências remotas (git fetch --all --prune)"
git fetch --all --prune

if [[ -n "$(git status --porcelain)" ]]; then
  log "Mudanças locais detectadas — executando git stash"
  git stash push -u -m "auto-stash $(date '+%F %T')" || true
else
  log "Sem mudanças locais para stash"
fi

log "Aplicando atualizações (git pull --rebase)"
git pull --rebase

log "Build do front Angular (produção)"
cd "$FRONT_DIR"
# Usa o ng local quando existir; senão, usa npx
export NODE_OPTIONS="${NODE_OPTIONS:---max-old-space-size=4096}"
npm ci --legacy-peer-deps
npx ng build --configuration=production --ssr=false --prerender=false

cd "$REPO_DIR"

log "Buildando imagens Docker sem paralelismo (mitiga falha intermitente do esbuild)"
$COMPOSE -f "$COMPOSE_FILE" build --no-parallel backend-container frontend-container

log "Subindo containers (em segundo plano)"
$COMPOSE -f "$COMPOSE_FILE" up -d

log "Concluído com sucesso ✅"
